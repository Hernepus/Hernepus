<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>VIEW - è‡ªåŠ¨ç›‘æ§å™¨</title>
  <style>
    :root { --primary-color: #2c3e50; --error-color: #e74c3c; }
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2em auto; padding: 1em; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #eee; border-radius: 50%; border-top: 3px solid var(--primary-color); animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .status-container { border: 1px solid #ccc; padding: 1em; margin-top: 1em; border-radius: 6px; background: #f9f9f9; }
    .update-alert { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 10px; margin-top: 10px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { background: #e8f5e9; } 50% { background: #c8e6c9; } }
    .debug-info { font-size: 0.8em; color: #666; margin-top: 10px; display: none; }
  </style>
</head>
<body>
  <h1>view.vtf è‡ªåŠ¨æ ¡éªŒå™¨ ğŸ”„</h1>
  <p style="background: #ecf0f1; padding: 10px; border-left: 4px solid #2ecc71;">
    è¿™ä¸ªç›‘è§†å™¨ç°åœ¨ä¼šæŒ‰ç…§ <strong>5ç§’ä¸€æ¬¡</strong> çš„é¢‘ç‡æ£€æµ‹æ›´æ–°ï¼Œå¦‚æœæœ‰æ›´æ–°ï¼Œä¼šç«‹å³ä¸‹è½½ <code>view.vtf</code> æ–‡ä»¶å¹¶æç¤ºä½ ã€‚
  </p>

  <div class="status-container">
    <div id="status">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
    <div id="debugConsole" class="debug-info"></div>
    <div id="historyLog"></div>
  </div>

  <button onclick="toggleMonitoring()">æš‚åœ/æ¢å¤ç›‘æ§</button>
  <button onclick="toggleDebug()" style="margin-left: 10px;">æ˜¾ç¤º/éšè—è°ƒè¯•</button>
  <span id="loadingIndicator" class="loading" style="display: none;"></span>

  <audio id="alertSound" src="https://library.hernepus.com/bye.WAV"></audio>
  <iframe id="hiddenDownloader" style="display:none;"></iframe>

  <script>
    const CONFIG = {
      proxyUrl: 'https://nextjs-boilerplate-theta-orcin-92.vercel.app/',
      originalFileUrl: 'https://wavespray.dathost.net/fastdl/teamfortress2/679d9656b8573d37aa848d60/materials/view.vtf',
      checkInterval: 5000,
      requestTimeout: 8000
    };

    let monitoringActive = true;
    let retryCount = 0;
    let lastFileSize = localStorage.getItem('lastFileSize') || null;
    let debugMode = false;

    const el = id => document.getElementById(id);
    const elements = {
      status: el('status'),
      historyLog: el('historyLog'),
      loading: el('loadingIndicator'),
      audio: el('alertSound'),
      downloader: el('hiddenDownloader'),
      debug: el('debugConsole')
    };

    document.addEventListener('DOMContentLoaded', () => checkUpdate());

    function toggleDebug() {
      debugMode = !debugMode;
      elements.debug.style.display = debugMode ? 'block' : 'none';
    }

    function toggleMonitoring() {
      monitoringActive = !monitoringActive;
      log(`ç›‘æ§å·²${monitoringActive ? 'æ¢å¤' : 'æš‚åœ'}`);
      if (monitoringActive) checkUpdate();
    }

    function log(msg) {
      const div = document.createElement('div');
      div.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
      elements.historyLog.prepend(div);
    }

    function debug(msg) {
      if (!debugMode) return;
      const div = document.createElement('div');
      div.textContent = `[DEBUG] ${new Date().toLocaleTimeString()} - ${msg}`;
      elements.debug.prepend(div);
    }

    function showLoading(show) {
      elements.loading.style.display = show ? 'inline-block' : 'none';
    }

    async function checkUpdate() {
      if (!monitoringActive) return;

      showLoading(true);
      try {
        const proxyURL = `${CONFIG.proxyUrl}?url=${encodeURIComponent(CONFIG.originalFileUrl)}&_=${Date.now()}`;
        debug(`è¯·æ±‚: ${proxyURL}`);

        const response = await fetch(proxyURL);
        const result = await response.json();
        debug(`å“åº”: ${JSON.stringify(result)}`);

        if (!response.ok || result.error) {
          throw new Error(result.error || 'ä»£ç†å“åº”å¤±è´¥');
        }

        const newSize = result.size;
        if (newSize && newSize !== lastFileSize) {
          handleFileUpdate(newSize);
        } else {
          log('æ–‡ä»¶æ— å˜åŒ–');
        }
      } catch (err) {
        log(`é”™è¯¯: ${err.message}`);
      } finally {
        showLoading(false);
        if (monitoringActive) {
          setTimeout(checkUpdate, CONFIG.checkInterval);
        }
      }
    }

    function handleFileUpdate(newSize) {
      elements.audio.play().catch(() => {});
      const msg = lastFileSize
        ? `æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ (å¤§å°å˜åŒ–: ${lastFileSize} â†’ ${newSize})`
        : `åˆå§‹åŒ–æ–‡ä»¶ç‰ˆæœ¬ä¸º ${newSize}`;
      log(msg);
      elements.status.innerHTML = `<div class="update-alert">${msg}</div>`;

      if (lastFileSize !== null) {
        const url = `${CONFIG.originalFileUrl}?ts=${Date.now()}`;
        elements.downloader.src = url;
        debug(`ä¸‹è½½è§¦å‘: ${url}`);
      }

      lastFileSize = newSize;
      localStorage.setItem('lastFileSize', newSize);
    }
  </script>
</body>
</html>
